kind: pipeline
name: nodeapp
steps:
  - name: build
    image: node:latest
    commands:
      - npm install

  - name: publish
    image: plugins/gcr
    tag: ${DRONE_COMMIT}
    settings:
      repo: gcr.io/project-one-266117/nodeapp
      json_key:
        from_secret: google_credentials

  - name: deploy
    image: nytimes/drone-gke:0.9.1
    region: us-east1
    zone: us-east1-b
    project: project-one-266117
    namespace: ${DRONE_BRANCH}
    cluster: mykubecluster
    expand_env_vars: true
    verbose: true
    vars:
      image: gcr.io/project-one-266117/nodeapp:${DRONE_COMMIT}
      app: nodeapp
      env: dev
      user: root
    environment:
      TOKEN:
        from_secret: google_credentials
      ZONE: us-east1-b
      REGION: us-east1

trigger:
  branch:
    - test_branch
  event:
    include:
    - push

